version: 1
backend:
  phases:
    preBuild:
      commands:
        - echo "Starting preBuild phase"
        - python --version
        - pip --version
        - ls -la
    build:
      commands:
        - echo "Starting build phase"
        # Install poetry and dependencies
        - pip install poetry
        - sed -i 's/python = ">=3.12"/python = ">=3.10"/g' pyproject.toml
        - pip install django==5.1.7 litellm==1.65.0 python-dotenv==1.1.0 cryptography==44.0.2 whitenoise==6.5.0
        
        # Debug filesystem
        - echo "Current directory structure:"
        - ls -la
        
        # Create necessary .env file with safe defaults
        - echo "Creating .env file"
        - echo "SECRET_KEY=temp-key-for-build-process-only" > .env
        - echo "DEBUG=False" >> .env
        
        # Set environment variables
        - export DJANGO_SETTINGS_MODULE=chatbot_project.settings
        - export PYTHONPATH=$(pwd)
        
        # Run Django check to verify configuration
        - echo "Running Django check"
        - python manage.py check
        
        # Run collectstatic
        - echo "Running collectstatic"
        - python manage.py collectstatic --noinput --verbosity 2
        
        # Final checks
        - echo "Checking staticfiles directory"
        - ls -la staticfiles/
        
        # Create a basic URL checker page
        - echo "<html><body><h1>App is running!</h1></body></html>" > staticfiles/check.html
  artifacts:
    baseDirectory: /
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*

frontend:
  phases:
    preBuild:
      commands:
        - echo "Starting frontend preBuild phase"
    build:
      commands:
        - echo "Starting frontend build phase"
        # Simple HTML page to ensure something is being served
        - mkdir -p public
        - echo "<html><head><title>MegBot</title></head><body><h1>MegBot is loading...</h1><p>If you see this page, static files are working but Django may not be.</p><p><a href='/check.html'>Check static file serving</a></p></body></html>" > public/index.html
  artifacts:
    baseDirectory: public
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: 'Cache-Control'
          value: 'no-store'
    - pattern: 'static/**/*'
      headers:
        - key: 'Cache-Control'
          value: 'max-age=31536000'