version: 1
backend:
  phases:
    preBuild:
      commands:
        - echo "Starting preBuild phase"
        - python --version
        - pip --version
    build:
      commands:
        - echo "Starting build phase"
        
        # Install dependencies in the correct order with exact versions
        - pip install --upgrade pip
        - pip install pydantic==2.4.2
        - pip install django==5.1.7 python-dotenv==1.1.0 cryptography==44.0.2 whitenoise==6.5.0 gunicorn==21.2.0
        - pip install litellm==1.65.0
        
        # Create static directory if it doesn't exist
        - mkdir -p static
        
        # Copy app static files to the project static directory
        - if [ -d "megbot/static" ]; then cp -r megbot/static/* static/; fi
        
        # Environment setup
        - echo "SECRET_KEY=temp-key-for-build-process-only" > .env
        - echo "DEBUG=False" >> .env
        - export DJANGO_SETTINGS_MODULE=chatbot_project.settings
        - export PYTHONPATH=$(pwd)
        
        # Run Django check
        - python manage.py check
        
        # Collect static files
        - python manage.py collectstatic --noinput
  artifacts:
    baseDirectory: /
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*

frontend:
  phases:
    build:
      commands: []
  artifacts:
    baseDirectory: /
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: 'Cache-Control'
          value: 'no-store'
    - pattern: 'static/**/*'
      headers:
        - key: 'Cache-Control'
          value: 'max-age=31536000'