version: 1
backend:
  phases:
    preBuild:
      commands:
        - echo "Starting preBuild phase"
        - python --version
        - pip install poetry==1.7.1
        - poetry config virtualenvs.create false
    build:
      commands:
        - echo "Starting build phase"
        
        # Install dependencies using Poetry
        - poetry install --no-interaction --no-ansi
        
        # Create static directory if it doesn't exist
        - mkdir -p static
        
        # Copy app static files to the project static directory
        - if [ -d "megbot/static" ]; then cp -r megbot/static/* static/; fi
        
        # Environment setup
        - echo "SECRET_KEY=temp-key-for-build-process-only" > .env
        - echo "DEBUG=False" >> .env
        - export DJANGO_SETTINGS_MODULE=chatbot_project.settings
        - export PYTHONPATH=$(pwd)
        
        # Run Django check
        - python manage.py check
        
        # Collect static files
        - python manage.py collectstatic --noinput
  artifacts:
    baseDirectory: /
    files:
      - '**/*'
  cache:
    paths:
      - .venv/**/*
      - node_modules/**/*

frontend:
  phases:
    build:
      commands: []
  artifacts:
    baseDirectory: /
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: 'Cache-Control'
          value: 'no-store'
    - pattern: 'static/**/*'
      headers:
        - key: 'Cache-Control'
          value: 'max-age=31536000'