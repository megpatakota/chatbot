version: 1
backend:
  phases:
    build:
      commands:
        # Install poetry
        - pip install poetry
        
        # Modify pyproject.toml to accept Python 3.10
        - sed -i 's/python = ">=3.12"/python = ">=3.10"/g' pyproject.toml
        
        # Install dependencies directly with pip with correct versions
        # First install pydantic v2 (required by LiteLLM)
        - pip install pydantic==2.4.2
        
        # Then install other dependencies
        - pip install django==5.1.7 python-dotenv==1.1.0 cryptography==44.0.2 whitenoise==6.5.0
        
        # Install LiteLLM last to ensure correct dependencies
        - pip install litellm==1.65.0
        
        # Add environment variable for non-interactive mode
        - export DJANGO_SETTINGS_MODULE=chatbot_project.settings
        - export PYTHONPATH=$(pwd)
        
        # Create a temporary .env file with a SECRET_KEY
        - echo "SECRET_KEY=temp-key-for-build-process-only" > .env
        
        # Run collectstatic
        - python manage.py collectstatic --noinput
  artifacts:
    baseDirectory: /
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*

frontend:
  phases:
    preBuild:
      commands:
        - echo "Setting up frontend assets"
    build:
      commands:
        - echo "No frontend build steps required"
  artifacts:
    baseDirectory: /
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: 'Cache-Control'
          value: 'max-age=86400'
    - pattern: 'static/**/*'
      headers:
        - key: 'Cache-Control'
          value: 'max-age=31536000'